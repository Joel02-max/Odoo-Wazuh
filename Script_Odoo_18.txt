#!/bin/bash
# Script para instalar Odoo 18 en Ubuntu
# Autor Angelo
# 20/08/2025

# ===============================
# Variables de configuración
# ===============================
ODOO_USER="joel"
ODOO_HOME="/home/$ODOO_USER/18"
ODOO_VENV="$ODOO_HOME/virt_odoo18"
ODOO_CONF="$ODOO_HOME/odoo18.conf"
ODOO_ADDONS="$ODOO_HOME/odoo/addons"
ODOO_DB_USER="odoo18_mivil"
ODOO_DB_PASS="12345"
ODOO_ADMIN_PASS="12345"
ODOO_PORT="8069"

# ===============================
# 1. Actualizar sistema
# ===============================
sudo apt update && sudo apt upgrade -y

# ===============================
# 2. Instalar dependencias
# ===============================
sudo apt install python3-pip build-essential wget \
libxslt-dev libzip-dev libldap2-dev libsasl2-dev python3-dev \
libjpeg-dev libpq-dev git python3-virtualenv -y

# ===============================
# 3. Instalar PostgreSQL y crear usuario
# ===============================
sudo apt install postgresql -y

sudo -u postgres psql <<EOF
CREATE USER $ODOO_DB_USER WITH PASSWORD '$ODOO_DB_PASS' CREATEDB;
EOF

# ===============================
# 4. Crear directorios y entorno virtual
# ===============================
mkdir -p $ODOO_HOME
cd $ODOO_HOME || exit

virtualenv -p python3 $ODOO_VENV
source $ODOO_VENV/bin/activate

# ===============================
# 5. Descargar Odoo 18
# ===============================
git clone https://github.com/odoo/odoo.git --branch=18.0 --depth=1

# ===============================
# 6. Instalar dependencias de Odoo
# ===============================
cd odoo || exit
pip install --upgrade pip
pip install -r requirements.txt
python setup.py install

# ===============================
# 7. Configurar archivo run.conf
# ===============================
cat > $ODOO_CONF <<EOL
[options]
addons_path = $ODOO_ADDONS
db_host = localhost
db_port = 5432
db_user = $ODOO_DB_USER
db_password = $ODOO_DB_PASS
admin_passwd = $ODOO_ADMIN_PASS
http_port = $ODOO_PORT
xmlrpc_interface = 0.0.0.0
netrpc_interface = 0.0.0.0
EOL

# ===============================
# 8. Instalar paquete recomendado
# ===============================
pip install lxml_html_clean

# ===============================
# 9. Crear servicio systemd
# ===============================
SERVICE_FILE="/etc/systemd/system/odoo18.service"
sudo tee $SERVICE_FILE > /dev/null <<EOL
[Unit]
Description=Odoo 18
Requires=postgresql.service
After=network.target postgresql.service

[Service]
Type=simple
User=$ODOO_USER
Group=$ODOO_USER
ExecStart=$ODOO_VENV/bin/odoo -c $ODOO_CONF
Restart=on-failure
TimeoutStopSec=60

[Install]
WantedBy=multi-user.target
EOL

# ===============================
# 10. Activar y arrancar el servicio
# ===============================
sudo systemctl daemon-reload
sudo systemctl enable odoo18
sudo systemctl start odoo18

echo "Instalación completa. Odoo 18 debería estar corriendo en http://<IP-SERVIDOR>:$ODOO_PORT"
